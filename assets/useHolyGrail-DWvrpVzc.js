import{r as i}from"./vendor-react-Dw6BNO4u.js";import{g as d,u as y}from"./index-bmFt9tlZ.js";const f={sync:async r=>{try{const u=d().currentUser;if(!u)throw new Error("Not authenticated");const l=await u.getIdToken(),a=await fetch("/api/grail/sync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({foundItemIds:r})});if(!a.ok)throw new Error("Failed to sync grail data");return await a.json()}catch(o){return console.error("[GrailAPI] Sync Error:",o),{success:!1}}}};function _(){const{user:r,isLoading:o}=y(),[u,l]=i.useState(!1),a=e=>e?`d2r_grail_${e}`:"d2r_holy_grail_found",[n,c]=i.useState(()=>{try{const e=localStorage.getItem("d2r_holy_grail_found");return e?new Set(JSON.parse(e)):new Set}catch{return new Set}});return i.useEffect(()=>{if(o)return;const e=a(r?.id),s=localStorage.getItem(e);if(s)try{c(new Set(JSON.parse(s)))}catch(t){console.error("Failed to parse stored grail data",t)}else if(r?.id){const t=localStorage.getItem("d2r_holy_grail_found");if(t){console.log("Migrating guest data to user account...");try{const g=JSON.parse(t);c(new Set(g))}catch{}}else c(new Set)}},[r,o]),i.useEffect(()=>{if(o)return;const e=a(r?.id);try{localStorage.setItem(e,JSON.stringify(Array.from(n)))}catch(s){console.error("Failed to save Holy Grail data",s)}},[n,r,o]),i.useEffect(()=>{if(!r||o)return;const s=setTimeout(async()=>{l(!0);try{await f.sync(Array.from(n))}catch(t){console.error("Cloud sync failed",t)}finally{l(!1)}},2e3);return()=>clearTimeout(s)},[n,r,o]),{foundItems:n,toggleItem:e=>{e&&c(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},isFound:e=>n.has(e),resetProgress:()=>{confirm("Are you sure you want to reset your Holy Grail progress? This cannot be undone.")&&c(new Set)},totalFound:n.size,isSyncing:u}}export{_ as u};
